apiVersion: batch/v1
kind: CronJob
metadata:
  name: gutendex-catalog-update
  namespace: ocean
spec:
  # Weekly on Sunday at 2am UTC
  schedule: "0 2 * * 0"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3
  jobTemplate:
    spec:
      # Allow 12 hours for catalog update
      activeDeadlineSeconds: 43200
      # Don't retry failed jobs automatically
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: gutendex
            component: catalog-update
        spec:
          restartPolicy: OnFailure
          # Security context for volume permissions
          securityContext:
            fsGroup: 1000
          containers:
            - name: catalog-update
              image: adamduongit/adam-gutendex:0.0.1
              imagePullPolicy: Always
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting weekly catalog update at $(date)"
                  python manage.py updatecatalog
                  echo "Collecting static files..."
                  python manage.py collectstatic --noinput
                  echo "Catalog update completed at $(date)"
              env:
                - name: SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: gutendex-secret
                      key: SECRET_KEY
                - name: DEBUG
                  value: "false"
                - name: ALLOWED_HOSTS
                  value: "*"
                - name: DATABASE_PATH
                  value: "/app/data/gutendex.db"
                - name: STATIC_ROOT
                  value: "/app/data/staticfiles"
                - name: MEDIA_ROOT
                  value: "/app/data/media"
                - name: CATALOG_DIR
                  value: "/app/data/catalog_files"
              volumeMounts:
                - name: data
                  mountPath: /app/data
              resources:
                requests:
                  cpu: '500m'
                  memory: '512Mi'
                limits:
                  cpu: '2000m'
                  memory: '2048Mi'
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: gutendex-data
          imagePullSecrets:
            - name: docker-registry-secret
